// server.js
import express from 'express';
import fetch from 'node-fetch';
import { createClient } from 'redis';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Redis client
const REDIS_URL = process.env.REDIS_URL || 'redis://localhost:6379';
const redisClient = createClient({ url: REDIS_URL });
redisClient.on('error', (err) => console.error('Redis error:', err));
await redisClient.connect();

// View engine
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// Serve static files (if needed)
app.use('/static', express.static(path.join(__dirname, 'static')));

// Main page
app.get('/', async (req, res) => {
    const userKey = await redisClient.get('gemimi_key') || '';
    const userLevel = await redisClient.get('user_level') || 'Giỏi';
    res.render('index', { userKey, userLevel });
});

// Save API key & level
app.post('/set-key', async (req, res) => {
    const { apiKey, level } = req.body;
    if(apiKey) await redisClient.set('gemimi_key', apiKey);
    if(level) await redisClient.set('user_level', level);
    res.json({ ok: true });
});

// Chat endpoint
app.post('/chat', async (req, res) => {
    const { message } = req.body;
    const apiKey = await redisClient.get('gemimi_key');
    const level = await redisClient.get('user_level') || 'Giỏi';

    if(!apiKey) return res.json({ error: 'API Key chưa được nhập.' });

    const prompt = `Bạn là một học sinh ${level}. Trả lời bài tập này giống hệt học sinh thực tế: "${message}"`;

    try {
        const response = await fetch('https://api.gemimi.ai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gemimi-1',
                messages: [{ role: 'user', content: prompt }]
            })
        });
        const data = await response.json();
        const answer = data.choices?.[0]?.message?.content || 'Không có phản hồi.';
        res.json({ answer });
    } catch (err) {
        console.error(err);
        res.json({ error: 'Lỗi khi gọi API Gemimi.' });
    }
});

// Inline EJS template
const viewsDir = path.join(__dirname, 'views');
if(!fs.existsSync(viewsDir)) fs.mkdirSync(viewsDir);

fs.writeFileSync(path.join(viewsDir, 'index.ejs'), `
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Học Sinh</title>
<style>
body{font-family:sans-serif;margin:0;background:#f5f5f5;}
header{background:#1a73e8;color:white;padding:1rem;display:flex;justify-content:space-between;align-items:center;}
.chat-container{max-width:800px;margin:2rem auto;padding:1rem;background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);}
.messages{height:400px;overflow-y:auto;border:1px solid #ddd;padding:1rem;margin-bottom:1rem;border-radius:5px;}
.message{margin-bottom:1rem;}
.message.user{text-align:right;color:#1a73e8;}
.message.ai{text-align:left;color:#333;}
input[type=text]{width:80%;padding:0.5rem;margin-right:0.5rem;border-radius:5px;border:1px solid #ccc;}
button{padding:0.5rem 1rem;border:none;border-radius:5px;background:#1a73e8;color:white;cursor:pointer;}
button:hover{opacity:0.9;}
#settingsModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.modal-content{background:white;padding:2rem;border-radius:8px;max-width:400px;width:90%;}
</style>
</head>
<body>
<header>
<h2>AI Học Sinh</h2>
<button id="settingsBtn">⋮</button>
</header>
<div class="chat-container">
<div class="messages" id="messages"></div>
<input type="text" id="inputMsg" placeholder="Nhập bài tập...">
<button id="sendBtn">Gửi</button>
</div>

<div id="settingsModal">
<div class="modal-content">
<h3>Cài đặt AI</h3>
<label>API Key:</label><br>
<input type="text" id="apiKeyInput" value="<%= userKey %>" style="width:100%;margin-bottom:1rem;"><br>
<label>Loại học sinh:</label><br>
<select id="levelSelect" style="width:100%;margin-bottom:1rem;">
<option value="Giỏi" <%= userLevel==='Giỏi'?'selected':'' %>>Giỏi</option>
<option value="Khá" <%= userLevel==='Khá'?'selected':'' %>>Khá</option>
<option value="Trung bình" <%= userLevel==='Trung bình'?'selected':'' %>>Trung bình</option>
<option value="Yếu" <%= userLevel==='Yếu'?'selected':'' %>>Yếu</option>
</select>
<button id="saveSettings">Lưu</button>
<button id="closeModal">Đóng</button>
</div>
</div>

<script>
const messagesDiv=document.getElementById('messages');
const inputMsg=document.getElementById('inputMsg');
const sendBtn=document.getElementById('sendBtn');
const settingsBtn=document.getElementById('settingsBtn');
const settingsModal=document.getElementById('settingsModal');
const closeModal=document.getElementById('closeModal');
const saveSettings=document.getElementById('saveSettings');
const apiKeyInput=document.getElementById('apiKeyInput');
const levelSelect=document.getElementById('levelSelect');

sendBtn.onclick=async()=>{
    const text=inputMsg.value.trim();
    if(!text) return;
    appendMessage('user', text);
    inputMsg.value='';
    try{
        const res=await fetch('/chat',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({message:text})
        });
        const data=await res.json();
        appendMessage('ai', data.answer||data.error);
    }catch(err){
        appendMessage('ai','Lỗi kết nối server.');
    }
};

function appendMessage(role,text){
    const div=document.createElement('div');
    div.className='message '+role;
    div.innerText=text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

// Modal
settingsBtn.onclick=()=>settingsModal.style.display='flex';
closeModal.onclick=()=>settingsModal.style.display='none';
saveSettings.onclick=async()=>{
    await fetch('/set-key',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({apiKey:apiKeyInput.value, level:levelSelect.value})
    });
    settingsModal.style.display='none';
};
</script>
</body>
</html>
`);

// Start server
const PORT = process.env.PORT || 3000;
app.listen(PORT, ()=>console.log(\`Server chạy tại http://localhost:\${PORT}\`));
